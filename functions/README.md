# Firebase Functions - Local Testing Guide

## Setup Complete! ðŸŽ‰

Your Firebase Functions project is now set up and ready for local testing.

## Directory Structure

```
functions/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.ts          # Main functions (order, subscription, payment notifications)
â”‚   â””â”€â”€ test.js           # Test functions for local development
â”œâ”€â”€ lib/                  # Compiled JavaScript (generated by build)
â”œâ”€â”€ package.json
â”œâ”€â”€ tsconfig.json
â”œâ”€â”€ .eslintrc.js
â”œâ”€â”€ .env                  # Environment variables (DO NOT COMMIT)
â””â”€â”€ .gitignore
```

## Prerequisites

1. **Install Firebase CLI globally**:

   ```bash
   npm install -g firebase-tools
   ```

2. **Login to Firebase**:

   ```bash
   firebase login
   ```

3. **Initialize Firebase project** (if not already done):
   ```bash
   firebase init
   ```
   - Select your existing Firebase project
   - Choose Functions, Firestore, and Emulators

## Configuration

### 1. Update `.env` file

Edit `functions/.env` with your actual values:

```bash
FIREBASE_PROJECT_ID=your-actual-project-id
WHATSAPP_API_URL=https://graph.facebook.com/v22.0
WHATSAPP_PHONE_NUMBER_ID=your_phone_number_id
WHATSAPP_ACCESS_TOKEN=your_whatsapp_access_token
```

### 2. Download Service Account Key

For local testing with real Firebase:

1. Go to Firebase Console > Project Settings > Service Accounts
2. Click "Generate New Private Key"
3. Save as `functions/serviceAccountKey.json`
4. **NEVER commit this file to git** (already in .gitignore)

## Local Testing

### Method 1: Firebase Emulators (Recommended)

Start all Firebase emulators locally:

```bash
# From project root
firebase emulators:start

# Or from functions directory
cd functions
npm run serve
```

This starts:

- Functions Emulator: http://localhost:5001
- Firestore Emulator: http://localhost:8080
- Auth Emulator: http://localhost:9099
- Emulator UI: http://localhost:4000

### Method 2: Functions Shell

Interactive shell for testing functions:

```bash
cd functions
npm run shell
```

Test functions interactively:

```javascript
// Test callable function
testCallable({ name: "John" });

// Test HTTP function
testFunction();
```

### Method 3: Direct Testing (Quick Start)

Build and test without emulators:

```bash
cd functions
npm run build
node -r dotenv/config lib/test.js
```

## Testing Your Functions

### Test HTTP Function

```bash
# Using curl
curl http://localhost:5001/YOUR_PROJECT_ID/us-central1/testFunction

# Or visit in browser
http://localhost:5001/YOUR_PROJECT_ID/us-central1/testFunction
```

### Test Callable Function

From your app or using the Firebase SDK:

```javascript
const functions = getFunctions();
const testCallable = httpsCallable(functions, "testCallable");
const result = await testCallable({ name: "Test User" });
console.log(result.data);
```

### Test Firestore Triggers

Create a document in the emulator:

```javascript
// In your app or using Firestore emulator UI
const db = getFirestore();
await addDoc(collection(db, "test"), {
  message: "This will trigger testFirestoreTrigger",
});
```

## Building Your Functions

Compile TypeScript to JavaScript:

```bash
cd functions
npm run build

# Or watch mode (auto-rebuild on changes)
npm run build:watch
```

## Testing Production Functions

### 1. Send WhatsApp OTP

```javascript
const sendOTP = httpsCallable(functions, "sendWhatsAppOTP");
const result = await sendOTP({ phone: "+919876543210" });
```

### 2. Verify OTP

```javascript
const verifyOTP = httpsCallable(functions, "verifyWhatsAppOTP");
const result = await verifyOTP({ phone: "+919876543210", otp: "123456" });
```

### 3. Test Order Notifications

Create/update an order in Firestore:

```javascript
const db = getFirestore();
const orderRef = doc(db, "orders", "test-order-123");
await setDoc(orderRef, {
  userId: "test-user-id",
  status: "confirmed",
  items: "Chicken Biryani x2",
  totalAmount: 500,
  deliveryTime: "7:00 PM",
});

// Update status to trigger notification
await updateDoc(orderRef, { status: "preparing" });
```

## Deployment

### Deploy all functions:

```bash
firebase deploy --only functions
```

### Deploy specific function:

```bash
firebase deploy --only functions:sendWhatsAppOTP
```

## Monitoring Logs

### Local logs:

Watch the terminal where emulators are running

### Production logs:

```bash
# View all logs
firebase functions:log

# View specific function logs
firebase functions:log --only sendWhatsAppOTP

# Follow logs in real-time
firebase functions:log --follow
```

## Common Issues & Solutions

### 1. Port already in use

```bash
# Kill process on port 5001
npx kill-port 5001

# Or use different ports in firebase.json
```

### 2. Emulator connection issues

```bash
# Clear emulator data
firebase emulators:start --clear-data
```

### 3. TypeScript compilation errors

```bash
cd functions
npm run build
# Fix any TypeScript errors shown
```

### 4. Missing environment variables

Ensure `.env` file is properly configured with all required values.

## Next Steps

1. âœ… Test with Firebase Emulators
2. âœ… Configure your WhatsApp Business API credentials
3. âœ… Test order notification flows
4. âœ… Test subscription workflows
5. âœ… Deploy to production
6. âœ… Monitor logs and performance

## Useful Commands

```bash
# Build TypeScript
npm run build

# Watch mode (auto-rebuild)
npm run build:watch

# Start emulators
npm run serve

# Interactive shell
npm run shell

# Deploy
npm run deploy

# View logs
npm run logs

# Lint code
npm run lint
```

## Resources

- [Firebase Functions Documentation](https://firebase.google.com/docs/functions)
- [Firebase Emulator Suite](https://firebase.google.com/docs/emulator-suite)
- [WhatsApp Business API](https://developers.facebook.com/docs/whatsapp/cloud-api)

## Support

For issues or questions, check:

- Firebase Console Logs
- Local emulator output
- WhatsApp API error messages in function logs
